<!DOCTYPE html>

<html>
<head>
  <title>utils.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="contents.html">
                contents.js
              </a>
            
              
              <a class="source" href="contentsGroup.html">
                contentsGroup.js
              </a>
            
              
              <a class="source" href="groups.html">
                groups.js
              </a>
            
              
              <a class="source" href="memberGroups.html">
                memberGroups.js
              </a>
            
              
              <a class="source" href="pois.html">
                pois.js
              </a>
            
              
              <a class="source" href="principals.html">
                principals.js
              </a>
            
              
              <a class="source" href="proposals.html">
                proposals.js
              </a>
            
              
              <a class="source" href="searchFilters.html">
                searchFilters.js
              </a>
            
              
              <a class="source" href="subGroups.html">
                subGroups.js
              </a>
            
              
              <a class="source" href="tags.html">
                tags.js
              </a>
            
              
              <a class="source" href="style-helpers.html">
                style-helpers.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="main.html">
                main.js
              </a>
            
              
              <a class="source" href="admins.html">
                admins.js
              </a>
            
              
              <a class="source" href="content.html">
                content.js
              </a>
            
              
              <a class="source" href="discovery.html">
                discovery.js
              </a>
            
              
              <a class="source" href="group.html">
                group.js
              </a>
            
              
              <a class="source" href="partners.html">
                partners.js
              </a>
            
              
              <a class="source" href="poi.html">
                poi.js
              </a>
            
              
              <a class="source" href="principal.html">
                principal.js
              </a>
            
              
              <a class="source" href="proposal.html">
                proposal.js
              </a>
            
              
              <a class="source" href="search.html">
                search.js
              </a>
            
              
              <a class="source" href="searchFilter.html">
                searchFilter.js
              </a>
            
              
              <a class="source" href="searchGroup.html">
                searchGroup.js
              </a>
            
              
              <a class="source" href="tag.html">
                tag.js
              </a>
            
              
              <a class="source" href="tagSet.html">
                tagSet.js
              </a>
            
              
              <a class="source" href="teacherSearch.html">
                teacherSearch.js
              </a>
            
              
              <a class="source" href="teachers.html">
                teachers.js
              </a>
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="adminsAsDiscovery.html">
                adminsAsDiscovery.js
              </a>
            
              
              <a class="source" href="discoveryAsContent.html">
                discoveryAsContent.js
              </a>
            
              
              <a class="source" href="oaeAsMainSearchGroup.html">
                oaeAsMainSearchGroup.js
              </a>
            
              
              <a class="source" href="oaeAsMainSearchResult.html">
                oaeAsMainSearchResult.js
              </a>
            
              
              <a class="source" href="oaeAsMainSearchResults.html">
                oaeAsMainSearchResults.js
              </a>
            
              
              <a class="source" href="oaeAsSecondarySearchGroup.html">
                oaeAsSecondarySearchGroup.js
              </a>
            
              
              <a class="source" href="oaeAsSecondarySearchResult.html">
                oaeAsSecondarySearchResult.js
              </a>
            
              
              <a class="source" href="oaeAsSecondarySearchResults.html">
                oaeAsSecondarySearchResults.js
              </a>
            
              
              <a class="source" href="oaeAsSpotlightItem.html">
                oaeAsSpotlightItem.js
              </a>
            
              
              <a class="source" href="oaeAsSpotlightList.html">
                oaeAsSpotlightList.js
              </a>
            
              
              <a class="source" href="partnersAsDiscovery.html">
                partnersAsDiscovery.js
              </a>
            
              
              <a class="source" href="poiAsMarker.html">
                poiAsMarker.js
              </a>
            
              
              <a class="source" href="poisAsMap.html">
                poisAsMap.js
              </a>
            
              
              <a class="source" href="searchAsForm.html">
                searchAsForm.js
              </a>
            
              
              <a class="source" href="searchFilterAsItem.html">
                searchFilterAsItem.js
              </a>
            
              
              <a class="source" href="searchFiltersAsList.html">
                searchFiltersAsList.js
              </a>
            
              
              <a class="source" href="tagAsCheckbox.html">
                tagAsCheckbox.js
              </a>
            
              
              <a class="source" href="tagSetAsCheckboxGroup.html">
                tagSetAsCheckboxGroup.js
              </a>
            
              
              <a class="source" href="tagSetAsInlineCheckboxGroup.html">
                tagSetAsInlineCheckboxGroup.js
              </a>
            
              
              <a class="source" href="tagsAsCheckboxes.html">
                tagsAsCheckboxes.js
              </a>
            
              
              <a class="source" href="teacherSearchAsPage.html">
                teacherSearchAsPage.js
              </a>
            
              
              <a class="source" href="teachersAsDiscovery.html">
                teachersAsDiscovery.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>utils.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*global _, $, Stem */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Generic JavaScript utilities that arenâ€™t part of
any model, view, collection, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Stem.Utils = Stem.Utils || {};

(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="hljs-pi">    'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Simple function to redirect to a new URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    Stem.Utils.redirect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, _blank)</span> </span>{
        <span class="hljs-keyword">if</span> (path) {
            <span class="hljs-keyword">if</span> (_blank) {
                <span class="hljs-built_in">window</span>.open(path);
            }
            <span class="hljs-built_in">window</span>.location = path;
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Function to convert an OAE path to a full URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    Stem.Utils.oaeUrl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Many OAE paths are relative URLs that
we need to convert to absolute ones
since weâ€™re referencing them from
a different site. Before we do that,
though, check to make sure the link
isnâ€™t already a full URL. (OAE never
includes the protocol in a relative
URL.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">if</span> (path.indexOf(<span class="hljs-string">'http'</span>) === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> path;
        }

        <span class="hljs-keyword">return</span> Stem.config.oae.protocol + <span class="hljs-string">'//'</span> +
               Stem.config.oae.host + path;

    };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Asynchronous function to get geo-location
information from the clientâ€™s IP address. Parameters
are a success and error callback function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    Stem.Utils.getLocationFromIp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(success, error)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>If weâ€™ve already cached the userâ€™s information
from a previous call or if itâ€™s available from
some other source (e.g. map API), just return
whatâ€™s available. This will avoid making
unnecessary (and potentially costly) API calls
to the IP info service.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">if</span> (Stem.user.geo.latitude &amp;&amp; Stem.user.geo.longitude) {

            success([
                Stem.user.geo.latitude,
                Stem.user.geo.longitude
            ]);

        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Since the info isnâ€™t otherwise available,
try querying the IP info service.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            $.getJSON(<span class="hljs-string">'http://ipinfo.io/json'</span>)
                .done(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(response)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The response should contain the
location info. A sample response:</p>
<pre><code>{
    ip: <span class="hljs-string">"73.54.166.233"</span>,
    hostname: <span class="hljs-string">"c-73-54-166-233.hsd1.ga.comcast.net"</span>,
    city: <span class="hljs-string">"Woodstock"</span>,
    region: <span class="hljs-string">"Georgia"</span>,
    country: <span class="hljs-string">"US"</span>,
    loc: <span class="hljs-string">"34.1190,-84.4477"</span>,
    org: <span class="hljs-string">"AS7922 Comcast Cable Communications, Inc."</span>,
    postal: <span class="hljs-string">"30188"</span>
}
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
                    <span class="hljs-keyword">var</span> latLong = <span class="hljs-literal">null</span>;

                    <span class="hljs-keyword">if</span> (response &amp;&amp; response.loc &amp;&amp;
                        (latLong = _.chain(response.loc.split(<span class="hljs-string">','</span>))
                            .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(s)</span> </span>{
                                <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>(s.trim());
                            }).filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span> </span>{
                                <span class="hljs-keyword">return</span> !_.isNaN(x);
                            }).value()) &amp;&amp;
                        (latLong.length === <span class="hljs-number">2</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Cache the response info.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                        Stem.user.geo.latitude  = latLong[<span class="hljs-number">0</span>];
                        Stem.user.geo.longitude = latLong[<span class="hljs-number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Return it to the original
caller via the success callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                        success([
                            Stem.user.geo.latitude,
                            Stem.user.geo.longitude
                        ]);

                    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>No location info in the
response! All we can do
now is return an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(error) === <span class="hljs-string">"function"</span>) {
                            error();
                        }

                    }

                })
                .fail(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Looks like weâ€™re out of luck.
If the original caller provided
an error callback, execute it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(error) === <span class="hljs-string">"function"</span>) {
                        error();
                    }

                });

        }

    };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Asynchronous function to get geo-location
information from a street address. Parameters
are the address and a success and error callback
function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    Stem.Utils.getLocationFromStreet = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(addr, success, error)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>For some reason, the Census Bureau seems to have
problems with zip+4 zip codes. So we strip them
out here. Also trim extra whitespace while weâ€™re
at it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        addr = addr.replace(<span class="hljs-regexp">/([0-9]{5})-[0-9]{4}/g</span>, <span class="hljs-string">'$1'</span>).trim();</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Make sure thereâ€™s an address to query.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        
        <span class="hljs-keyword">if</span> (addr.length) {

            $.ajax({
                    url: <span class="hljs-string">'http://geocoding.geo.census.gov/geocoder/locations/onelineaddress?'</span> +
                            <span class="hljs-string">'address='</span> + <span class="hljs-built_in">encodeURIComponent</span>(addr) +
                            <span class="hljs-string">'&amp;benchmark=9&amp;format=jsonp'</span>,
                    dataType: <span class="hljs-string">"jsonp"</span>
                })
                .done(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(response)</span> </span>{
    
                    <span class="hljs-keyword">if</span> (response.result &amp;&amp;
                        response.result.addressMatches &amp;&amp;
                        response.result.addressMatches.length &amp;&amp;
                        response.result.addressMatches[<span class="hljs-number">0</span>].coordinates &amp;&amp;
                        response.result.addressMatches[<span class="hljs-number">0</span>].coordinates.x &amp;&amp;
                        response.result.addressMatches[<span class="hljs-number">0</span>].coordinates.y &amp;&amp;
                        !_.isNaN(<span class="hljs-built_in">parseFloat</span>(response.result.addressMatches[<span class="hljs-number">0</span>].coordinates.x)) &amp;&amp;
                        !_.isNaN(<span class="hljs-built_in">parseFloat</span>(response.result.addressMatches[<span class="hljs-number">0</span>].coordinates.y))) {
    
                        success([
                            <span class="hljs-built_in">parseFloat</span>(response.result.addressMatches[<span class="hljs-number">0</span>].coordinates.y),
                            <span class="hljs-built_in">parseFloat</span>(response.result.addressMatches[<span class="hljs-number">0</span>].coordinates.x)
                        ]);
    
                    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Sometimes the Census Bureau has problems with
NE in the address. (Maybe Nebraska!?) If this
address has it, then strip it out and try again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
                        <span class="hljs-keyword">if</span> (addr.indexOf(<span class="hljs-string">' NE '</span>) &gt; <span class="hljs-number">0</span>) {
    
                            Stem.Utils.getLocationFromStreet(
                                addr.replace(<span class="hljs-regexp">/ NE /</span>, <span class="hljs-string">' '</span>),
                                success,
                                error
                            );</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Try the same for NW in the address.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (addr.indexOf(<span class="hljs-string">' NW '</span>) &gt; <span class="hljs-number">0</span>) {
    
                            Stem.Utils.getLocationFromStreet(
                                addr.replace(<span class="hljs-regexp">/ NW /</span>, <span class="hljs-string">' '</span>),
                                success,
                                error
                            );
    
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(error) === <span class="hljs-string">"function"</span>) {
    
                            error();
    
                        }
    
                    }
    
                })
                .fail(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(error) === <span class="hljs-string">"function"</span>) {
                        error();
                    }
    
                });
        
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If there wasnâ€™t a valid address, report
a failure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(error) === <span class="hljs-string">"function"</span>) {
                error();
            }

        }

    };


})();</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
