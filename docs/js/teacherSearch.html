<!DOCTYPE html>

<html>
<head>
  <title>teacherSearch.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="contents.html">
                contents.js
              </a>
            
              
              <a class="source" href="contentsGroup.html">
                contentsGroup.js
              </a>
            
              
              <a class="source" href="groups.html">
                groups.js
              </a>
            
              
              <a class="source" href="memberGroups.html">
                memberGroups.js
              </a>
            
              
              <a class="source" href="pois.html">
                pois.js
              </a>
            
              
              <a class="source" href="principals.html">
                principals.js
              </a>
            
              
              <a class="source" href="proposals.html">
                proposals.js
              </a>
            
              
              <a class="source" href="searchFilters.html">
                searchFilters.js
              </a>
            
              
              <a class="source" href="subGroups.html">
                subGroups.js
              </a>
            
              
              <a class="source" href="tags.html">
                tags.js
              </a>
            
              
              <a class="source" href="style-helpers.html">
                style-helpers.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="main.html">
                main.js
              </a>
            
              
              <a class="source" href="admins.html">
                admins.js
              </a>
            
              
              <a class="source" href="content.html">
                content.js
              </a>
            
              
              <a class="source" href="discovery.html">
                discovery.js
              </a>
            
              
              <a class="source" href="group.html">
                group.js
              </a>
            
              
              <a class="source" href="partners.html">
                partners.js
              </a>
            
              
              <a class="source" href="poi.html">
                poi.js
              </a>
            
              
              <a class="source" href="principal.html">
                principal.js
              </a>
            
              
              <a class="source" href="proposal.html">
                proposal.js
              </a>
            
              
              <a class="source" href="search.html">
                search.js
              </a>
            
              
              <a class="source" href="searchFilter.html">
                searchFilter.js
              </a>
            
              
              <a class="source" href="searchGroup.html">
                searchGroup.js
              </a>
            
              
              <a class="source" href="tag.html">
                tag.js
              </a>
            
              
              <a class="source" href="tagSet.html">
                tagSet.js
              </a>
            
              
              <a class="source" href="teacherSearch.html">
                teacherSearch.js
              </a>
            
              
              <a class="source" href="teachers.html">
                teachers.js
              </a>
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="adminsAsDiscovery.html">
                adminsAsDiscovery.js
              </a>
            
              
              <a class="source" href="discoveryAsContent.html">
                discoveryAsContent.js
              </a>
            
              
              <a class="source" href="oaeAsMainSearchGroup.html">
                oaeAsMainSearchGroup.js
              </a>
            
              
              <a class="source" href="oaeAsMainSearchResult.html">
                oaeAsMainSearchResult.js
              </a>
            
              
              <a class="source" href="oaeAsMainSearchResults.html">
                oaeAsMainSearchResults.js
              </a>
            
              
              <a class="source" href="oaeAsSecondarySearchGroup.html">
                oaeAsSecondarySearchGroup.js
              </a>
            
              
              <a class="source" href="oaeAsSecondarySearchResult.html">
                oaeAsSecondarySearchResult.js
              </a>
            
              
              <a class="source" href="oaeAsSecondarySearchResults.html">
                oaeAsSecondarySearchResults.js
              </a>
            
              
              <a class="source" href="oaeAsSpotlightItem.html">
                oaeAsSpotlightItem.js
              </a>
            
              
              <a class="source" href="oaeAsSpotlightList.html">
                oaeAsSpotlightList.js
              </a>
            
              
              <a class="source" href="partnersAsDiscovery.html">
                partnersAsDiscovery.js
              </a>
            
              
              <a class="source" href="poiAsMarker.html">
                poiAsMarker.js
              </a>
            
              
              <a class="source" href="poisAsMap.html">
                poisAsMap.js
              </a>
            
              
              <a class="source" href="searchAsForm.html">
                searchAsForm.js
              </a>
            
              
              <a class="source" href="searchFilterAsItem.html">
                searchFilterAsItem.js
              </a>
            
              
              <a class="source" href="searchFiltersAsList.html">
                searchFiltersAsList.js
              </a>
            
              
              <a class="source" href="tagAsCheckbox.html">
                tagAsCheckbox.js
              </a>
            
              
              <a class="source" href="tagSetAsCheckboxGroup.html">
                tagSetAsCheckboxGroup.js
              </a>
            
              
              <a class="source" href="tagSetAsInlineCheckboxGroup.html">
                tagSetAsInlineCheckboxGroup.js
              </a>
            
              
              <a class="source" href="tagsAsCheckboxes.html">
                tagsAsCheckboxes.js
              </a>
            
              
              <a class="source" href="teacherSearchAsPage.html">
                teacherSearchAsPage.js
              </a>
            
              
              <a class="source" href="teachersAsDiscovery.html">
                teachersAsDiscovery.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>teacherSearch.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*global Stem, _, Backbone*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Backbone model that backs the teacher-focused
search page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Stem.Models = Stem.Models || {};

(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="hljs-pi">    'use strict'</span>;

    Stem.Models.TeacherSearch = Backbone.Model.extend({

        setupSearch: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>If no search query was provided when
the model was created, we create our
own.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'searchQuery'</span>)) {

                <span class="hljs-keyword">var</span> searchQuery = <span class="hljs-keyword">new</span> Stem.Models.Search({
                    label: <span class="hljs-string">'Search resources'</span>,
                    placeholder: <span class="hljs-string">'Search the Incubator'</span>
                });

                <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'searchQuery'</span>,searchQuery);

            }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>If that model changes, we’ll want to update
the live searches. Because we’re tracking user
keystrokes, we debounce the update to avoid
hammering the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'searchQuery'</span>).on(
                <span class="hljs-string">'change'</span>,
                _(<span class="hljs-keyword">this</span>.updateResults).debounce(<span class="hljs-number">250</span>),
                <span class="hljs-keyword">this</span>
            );

        },

        setupTags: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Create a collection of tags for grade levels
to augment the search query.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> gradeLevelTags = <span class="hljs-keyword">new</span> Stem.Collections.Tags([
                <span class="hljs-keyword">new</span> Stem.Models.Tag({ label: <span class="hljs-string">'P-2'</span> }),
                <span class="hljs-keyword">new</span> Stem.Models.Tag({ label: <span class="hljs-string">'3-5'</span> }),
                <span class="hljs-keyword">new</span> Stem.Models.Tag({ label: <span class="hljs-string">'6-8'</span> }),
                <span class="hljs-keyword">new</span> Stem.Models.Tag({ label: <span class="hljs-string">'9-12'</span> })
            ]);

            <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'gradeLevelTags'</span>, gradeLevelTags);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Update the search results whenever the user
selects or deselects a tag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.listenTo(gradeLevelTags,<span class="hljs-string">'change'</span>, <span class="hljs-keyword">this</span>.updateResults);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Create a tag set from the collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'gradeLevelTagSet'</span>, <span class="hljs-keyword">new</span> Stem.Models.TagSet({
                title: <span class="hljs-string">'Grade level'</span>,
                tags: gradeLevelTags
            }));

        },

        getQueryTags: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Create an augmented search query based on the
tag settings. Start with an empty query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> query = <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Look at each tag one at a time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gradeLevelTags'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tag)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>If the tag isn’t selected, then we can
skip it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">if</span> (tag.get(<span class="hljs-string">'selected'</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>For selected tags, we use “domain
specific knowledge” to hack the
search query.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    <span class="hljs-keyword">switch</span> (tag.get(<span class="hljs-string">'label'</span>)) {
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'P-2'</span>:
                            query += <span class="hljs-string">', "primary school"'</span> +
                                     <span class="hljs-string">', "elementary school"'</span> +
                                     <span class="hljs-string">', p-2, k-2'</span> +
                                     <span class="hljs-string">', preschool, kindergarten'</span> +
                                     <span class="hljs-string">', "1st grade", "first grade"'</span> +
                                     <span class="hljs-string">', "2nd grade", "second grade"'</span>;
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'3-5'</span>:
                            query += <span class="hljs-string">', "primary school"'</span> +
                                     <span class="hljs-string">', "elementary school"'</span> +
                                     <span class="hljs-string">', 3-5, "3rd grade", "third grade"'</span> +
                                     <span class="hljs-string">', "4th grade", "fourth grade"'</span> +
                                     <span class="hljs-string">', "5th grade", "fifth grade"'</span>;
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'6-8'</span>:
                            query += <span class="hljs-string">', "secondary school"'</span> +
                                     <span class="hljs-string">', 6-8, "middle school"'</span> +
                                     <span class="hljs-string">', "6th grade", "sixth grade"'</span> +
                                     <span class="hljs-string">', "7th grade", "seventh grade"'</span> +
                                     <span class="hljs-string">', "8th grade", "eighth grade"'</span>;
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'9-12'</span>:
                            query += <span class="hljs-string">', "secondary school"'</span> +
                                     <span class="hljs-string">', 9-12, "high school"'</span> +
                                     <span class="hljs-string">', "9th grade", "ninth grade"'</span> +
                                     <span class="hljs-string">', "10th grade", "tenth grade"'</span> +
                                     <span class="hljs-string">', "11th grade", "eleventh grade"'</span> +
                                     <span class="hljs-string">', "12th grade", "twelfth grade"'</span>;
                            <span class="hljs-keyword">break</span>;
                    }

                }

            });

            <span class="hljs-keyword">return</span> query;

        },

        setupFacets: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>There are many facets to a particular
search query. Each facet includes a
filter (to prioritize that facet) and
a collection of results that
correspond to it. We allow the facets
to be predefined when the model is
created to provide maximum flexibility
(and ease of unit testing), though,
in most cases we’ll set them up here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'facets'</span>)) {

                <span class="hljs-keyword">var</span> facets = {

                    content: {

                        filter: <span class="hljs-keyword">new</span> Stem.Models.SearchFilter({
                            icon: <span class="hljs-string">'fa-cloud-download'</span>,
                            selected: <span class="hljs-literal">true</span>,
                            tagSet: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gradeLevelTagSet'</span>),
                            title: <span class="hljs-string">'Resources and units'</span>
                        }),
                        results: <span class="hljs-keyword">new</span> Stem.Models.SearchGroup({
                            collection: <span class="hljs-keyword">new</span> Stem.Collections.Contents([], {
                                 limit: <span class="hljs-number">16</span>
                            }),
                            heading: <span class="hljs-string">'Resources and units'</span>,
                            moreLink: Stem.config.oae.protocol + <span class="hljs-string">'//'</span> +
                                      Stem.config.oae.host + <span class="hljs-string">'/search/?types=content'</span>
                        })

                    },

                    courses: {

                        filter: <span class="hljs-keyword">new</span> Stem.Models.SearchFilter({
                            icon: <span class="hljs-string">'fa-certificate'</span>,
                            title: <span class="hljs-string">'Professional learning'</span>
                        }),
                        results: <span class="hljs-keyword">new</span> Stem.Models.SearchGroup({</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>switch to ContentsGroup on transition to content
collection: new Stem.Collections.ContentsGroup([], {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            collection: <span class="hljs-keyword">new</span> Stem.Collections.MemberGroups([], {
                                limit: <span class="hljs-number">16</span>,
                                parentId: Stem.config.oae.groups.courses
                            }),
                            heading: <span class="hljs-string">'Professional Learning'</span>,
                            moreLink: Stem.config.oae.protocol + <span class="hljs-string">'//'</span> +
                                      Stem.config.oae.host + <span class="hljs-string">'/group/si/m179WbZq/members'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <pre><code>   Stem.config.oae.host + <span class="hljs-string">'/group/si/m179WbZq/library'</span>
</code></pre><p>switch to /library on transition to content</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        })

                    },

                    groups: {

                        filter: <span class="hljs-keyword">new</span> Stem.Models.SearchFilter({
                            icon: <span class="hljs-string">'fa-comments-o'</span>,
                            title: <span class="hljs-string">'Groups and organizations'</span>
                        }),
                        results:  <span class="hljs-keyword">new</span> Stem.Models.SearchGroup({
                            collection: <span class="hljs-keyword">new</span> Stem.Collections.Principals([], {
                                limit: <span class="hljs-number">16</span>
                            }),
                            heading: <span class="hljs-string">'Groups and organizations'</span>,
                            moreLink: Stem.config.oae.protocol + <span class="hljs-string">'//'</span> +
                                      Stem.config.oae.host + <span class="hljs-string">'/search/?types=user,group'</span>
                        })

                    }

                };

                <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'facets'</span>, facets);

            }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Create a filters collection to hold all of the
facet filters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'searchFilters'</span>,
                <span class="hljs-keyword">new</span> Stem.Collections.SearchFilters()
            );</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Add each filter to that collection. While we’re
iterating thought the filters, pick out the
particular facet that is initially selected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            _(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'facets'</span>)).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(facet, key)</span> </span>{

                <span class="hljs-keyword">if</span> (facet.filter) {

                    <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'searchFilters'</span>).add(facet.filter);

                    <span class="hljs-keyword">if</span> (facet.filter.get(<span class="hljs-string">'selected'</span>)) {

                        <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'facet'</span>, key);

                    }

                }

            }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Watch for any changes to the filters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'searchFilters'</span>).on(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">this</span>.filterChanged, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Also watch for any parent object changing the facet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'change:facet'</span>, <span class="hljs-keyword">this</span>.updateFacet, <span class="hljs-keyword">this</span>);

        },

        initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Set up the individual components of the
model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.setupSearch();
            <span class="hljs-keyword">this</span>.setupTags();
            <span class="hljs-keyword">this</span>.setupFacets();</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Now that everything is set up, perform
the initial search query.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.updateResults();

        },

        updateFacet: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Somebody updated the search facet. Figure
out which one they want by looking for a
match within our facets object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            _(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'facets'</span>)).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(facet, key)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>If we find a match, set the filter to
be selected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'facet'</span>) === key) &amp;&amp; facet.filter) {
                    facet.filter.set(<span class="hljs-string">'selected'</span>,<span class="hljs-literal">true</span>);
                }

            }, <span class="hljs-keyword">this</span>);

        },

        updateResults: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Gather the keywords and terms for the search.
Start with whatever the user has typed into
the free-form query and augment that input
with tag-based additions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> keywords = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'searchQuery'</span>).get(<span class="hljs-string">'query'</span>),
                extendedKeywords = keywords + <span class="hljs-keyword">this</span>.getQueryTags();</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Update the collections and trigger new
fetches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            _(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'facets'</span>)).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(facet, key)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Make sure there’s a results model to
update.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">if</span> (facet.results) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If we do have a results model,
change the options on it’s collection
to match the new search query. If
the facet is <code>content</code>, then use
the extended keywords that include
tags. Otherwise, just use the basic
keywords.</p>
<p>After updating the options, trigger
a fetch on the collection to get
new results.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    facet.results.get(<span class="hljs-string">'collection'</span>).options({
                        keywords: key === <span class="hljs-string">'content'</span> ?
                            extendedKeywords : keywords
                    }).fetch({reset: <span class="hljs-literal">true</span>, validate: <span class="hljs-literal">true</span>});

                }

            }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>We also want to update the “More” links
associated with each search results. First
figure out a URL to use.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> oaeUrl = Stem.config.oae.protocol + <span class="hljs-string">'//'</span> +
                         Stem.config.oae.host + <span class="hljs-string">'/search/'</span> +
                         <span class="hljs-built_in">encodeURIComponent</span>(keywords) + <span class="hljs-string">'?types='</span>,
                extendedUrl = Stem.config.oae.protocol + <span class="hljs-string">'//'</span> +
                         Stem.config.oae.host + <span class="hljs-string">'/search/'</span> +
                         <span class="hljs-built_in">encodeURIComponent</span>(extendedKeywords) + <span class="hljs-string">'?types='</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Now update the model with the new URLs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'facets'</span>).content.results.set(<span class="hljs-string">'moreLink'</span>, extendedUrl + <span class="hljs-string">'content'</span>);
            <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'facets'</span>).groups.results.set(<span class="hljs-string">'moreLink'</span>, oaeUrl + <span class="hljs-string">'user,group'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Update the hash in the browser’s address bar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>.updateHash();

        },

        filterChanged: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(filter)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Most of the time, when one filter
changes, all the others will as
well. We only care about the filter
that’s now selected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">if</span> (filter.get(<span class="hljs-string">'selected'</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Find the specific filter in our
set so that we can update the
facet attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                _(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'facets'</span>)).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(facet, key)</span> </span>{

                    <span class="hljs-keyword">if</span> (facet.filter === filter) {
                        <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'facet'</span>,key);
                    }

                }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Update the browser’s address bar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">this</span>.updateHash();
            }

        },

        updateHash: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Let folks upstream know when the URL hash
can be changed.</p>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Start by extracting the query.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> query = <span class="hljs-built_in">encodeURIComponent</span>(
                <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'searchQuery'</span>).get(<span class="hljs-string">'query'</span>)
            );</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Add the appropriate facet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            _(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'facets'</span>)).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(facet, key)</span> </span>{

                <span class="hljs-keyword">if</span> ((facet.filter) &amp;&amp; (facet.filter.get(<span class="hljs-string">'selected'</span>))) {
                    query += <span class="hljs-string">'/'</span> + key;
                }

            }, <span class="hljs-keyword">this</span>);

            <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'navigate'</span>, query);

        }

    });

})();</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
